<!doctype html>
<html>
<body>
  <script>

  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;


  ga('create', 'UA-XXXXX-Y', 'auto');


  // Note(philipwalton):
  // Selenium on Windows 10 Edge doesn't handle arrays well, so we fake it.
  var hitData = {count: 0};
  ga('set', 'sendHitTask', function(model) {
    hitData[hitData.count] = {
      eventCategory: model.get('eventCategory'),
      eventAction: model.get('eventAction'),
      nonInteraction: model.get('nonInteraction')
    };
    hitData.count++;
  });


  ga('require', 'sessionDurationTracker');


  ga(function() {
    window.addEventListener('unload', function(event) {
      var data = JSON.stringify({
        sessionDurationMessage: hitData
      });
      window.parent.postMessage(data, '*');
    });
  });


  ga(function(tracker) {
    var originalXHROpen = XMLHttpRequest.prototype.open;
    var originalXHRSend = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.open = function(verb, url, async) {
      var data = JSON.stringify({
        sessionDurationMessage: {verb: verb, url: url, async: async}
      });
      window.parent.postMessage(data, '*');
      originalXHROpen.call(this, verb, url, async);
    };
    XMLHttpRequest.prototype.send = function(payload) {
      var data = JSON.stringify({
        sessionDurationMessage: {
          eventCategory: tracker.get('eventCategory'),
          eventAction: tracker.get('eventAction'),
          nonInteraction: tracker.get('nonInteraction')
        }
      });
      window.parent.postMessage(data, '*');
      originalXHRSend.call(payload);
    };
  });

  </script>

  <a id="outbound-link" href="http://google-analytics.com/collect">Outbound</a>

  <script async src='//www.google-analytics.com/analytics.js'></script>
  <script aysnc src="/dist/autotrack.js"></script>

</body>
</html>
